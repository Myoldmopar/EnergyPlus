name: Linux Debug Unit Test Coverage

on: [push]

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v1
      - name: apt-deps
        run: sudo apt-get install gfortran lcov gcovr
      - name: configure_with_coverage
        run: mkdir build && cd build && cmake -DCMAKE_BUILD_TYPE=Debug -DCOMMIT_SHA=aaaaaa$COMMIT_SHA -DBUILD_FORTRAN=ON -DBUILD_TESTING=ON -DENABLE_COVERAGE:BOOL=ON -DENABLE_GTEST_DEBUG_MODE:BOOL=OFF .. && cd ..
      - name: make
        run: cd build && make -j 3 && cd ..
      - name: run_unit_tests
        run: cd build && ctest -j 2 --timeout 4800 --no-compress-output -D ExperimentalTest -C Debug -R "integration.*" && cd ..
      - name: run_lcov
        run: cd build && lcov -c -d . -o ./lcov.output --no-external --base-directory ../src/EnergyPlus && cd ..
      - name: filter_lcov
        run: cd build && lcov -r ./lcov.output `pwd`/\\* -o ./lcov.output.filtered && cd ..
      - name: generate_html
        run: cd build && genhtml ./lcov.output.filtered -o lcov-html --demangle-cpp --function-coverage && cd ..
      - name: tarball_coverage
        run: cd build && tar -czvf integration_test_coverage.tar.gz lcov-html/ && cd ..
      - name: archive_coverage
        uses: actions/upload-artifact@v1
        with:
          name: integration_test_coverage
          path: build/integration_test_coverage.tar.gz
